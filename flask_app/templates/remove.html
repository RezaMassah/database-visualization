{% extends 'base.html' %}

{% block title %}Load/Remove Data{% endblock %}

{% block content %}
    <style>
        /* Basic styling for the table and page */
        body {
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
            margin: 0;
            padding: 0;
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }

        p {
            text-align: center;
            margin-bottom: 20px;
            color: #555;
        }

        form {
            width: 90%;
            margin: 0 auto;
            text-align: center;
        }

        table {
            width: 100%;
            margin: 20px auto;
            border-collapse: collapse;
            background-color: #fff;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        table th, table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: center;
        }

        table th {
            background-color: #333;
            color: #fff;
            text-transform: uppercase;
        }

        table tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        table tr:hover {
            background-color: #f1f1f1;
        }

        /* Button container for alignment */
        .button-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        button {
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            font-size: 16px;
            font-weight: bold;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #218838;
        }

        #remove-button {
            background-color: #dc3545;
        }

        #remove-button:hover {
            background-color: #c82333;
        }
    </style>

    <!-- <h1>Load/Remove Data</h1> -->

    <!-- Table to display data -->
    <form id="action-form" method="POST">
        <table>
            <thead>
                <tr>
                    <th>Select</th>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Description</th>
                    <th>File</th>
                </tr>
            </thead>
            <tbody id="data-table-body">
                <!-- Rows dynamically populated -->
            </tbody>
        </table>

        <!-- Button container to align buttons horizontally -->
        <div class="button-container">
            <button id="download-button" type="button">Download Selected</button>
            <button id="remove-button" type="submit" formaction="{{ url_for('main.delete_selected') }}">Remove Selected</button>
        </div>
    </form>
{% endblock %}

{% block scripts %}
    <!-- Embed data and load dynamic content with JavaScript -->
    <script>
        const data = JSON.parse('{{ data | tojson | safe }}');
        console.log("Serialized Data from Flask:", data);

        document.addEventListener("DOMContentLoaded", () => {
            const tableBody = document.getElementById("data-table-body");

            // Populate the table dynamically
            data.forEach(item => {
                const row = document.createElement("tr");

                // Checkbox for selection
                const selectCell = document.createElement("td");
                const checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.name = "selected_ids";
                checkbox.value = item.id;  // Pass the ID to the form
                selectCell.appendChild(checkbox);

                // Create cells for each field
                const idCell = document.createElement("td");
                idCell.textContent = item.id;

                const nameCell = document.createElement("td");
                nameCell.textContent = item.name;

                const descCell = document.createElement("td");
                descCell.textContent = item.description;

                const fileCell = document.createElement("td");
                fileCell.textContent = item.file ? "✅" : "❌";

                // Append cells to the row
                row.appendChild(selectCell);
                row.appendChild(idCell);
                row.appendChild(nameCell);
                row.appendChild(descCell);
                row.appendChild(fileCell);

                // Append row to the table
                tableBody.appendChild(row);
            });

            // Handle download functionality
            document.getElementById("download-button").addEventListener("click", async () => {
                const selectedIds = Array.from(document.querySelectorAll('input[name="selected_ids"]:checked'))
                    .map(checkbox => checkbox.value);

                if (selectedIds.length === 0) {
                    alert("Please select at least one item to download.");
                    return;
                }

                // Send a fetch request to download the files
                const response = await fetch("{{ url_for('main.download_selected') }}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({ selected_ids: selectedIds }),
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const link = document.createElement("a");
                    link.href = window.URL.createObjectURL(blob);
                    link.download = "files.zip"; 
                    link.click();
                } else {
                    alert("Failed to download files.");
                }
            });
        });
    </script>
{% endblock %}

{% block footer %}
    <p>&copy; 2024 Flask Project</p>
{% endblock %}
